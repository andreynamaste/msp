# Склейка видео - Описание проекта

## Обзор проекта

**Склейка видео** - это веб-сервис для склейки видео с аутентификацией, написанный на Python с использованием FastAPI. Сервис предоставляет REST API для объединения нескольких видео в одно с настройкой соотношения сторон и качества.

## Основные характеристики

- **Версия**: 4.0
- **Фреймворк**: FastAPI
- **Язык**: Python 3.12+
- **Дизайн**: Glass UI (современный стеклянный дизайн с градиентами)
- **Аутентификация**: JWT токены + API ключи
- **Хранение данных**: JSON файлы (users.json, api_keys.json)
- **Обработка видео**: FFmpeg
- **Root path**: `/scotch`

## Структура проекта

```
/opt/video/
├── glass_design_main.py      # Основной файл приложения FastAPI
├── api_key_system.py         # Система управления API ключами
├── persistent_users.py        # Система управления пользователями
├── requirements.txt          # Python зависимости
├── users.json                # База данных пользователей
├── api_keys.json             # База данных API ключей
├── backups/                   # Резервные копии API ключей
└── scotch-*.jsonc           # Конфигурационные файлы для интеграций
```

## Функциональность

### 1. Аутентификация и авторизация
- Регистрация пользователей с хешированием паролей (PBKDF2-SHA256)
- Вход с JWT токенами (срок действия 1 час)
- Система API ключей с возможностью создания нескольких ключей
- Управление API ключами (создание, просмотр, отзыв)

### 2. Склейка видео
- Объединение до 5 видео в одно
- Поддержка форматов: 16:9, 9:16, 1:1, 4:3
- Настройки качества: low, medium, high, ultra
- Асинхронная обработка в фоне
- Отслеживание прогресса задач
- Кэширование результатов

### 3. Веб-интерфейс
- Glass дизайн с анимированным фоном
- Страницы регистрации и входа
- Главная страница с навигацией
- Адаптивный дизайн

### 4. API Endpoints

#### Публичные
- `GET /` - Главная страница
- `GET /register` - Страница регистрации
- `GET /login` - Страница входа
- `GET /server2/videoapi/` - Информация об API
- `GET /server2/videoapi/health` - Проверка состояния
- `GET /server2/videoapi/download/{task_id}` - Скачивание готового видео

#### Защищенные (требуют аутентификации)
- `POST /server2/videoapi/auth/register` - Регистрация
- `POST /server2/videoapi/auth/login` - Вход
- `POST /server2/videoapi/merge` - Склейка видео
- `GET /server2/videoapi/task/{task_id}` - Статус задачи
- `POST /server2/videoapi/auth/create-api-key` - Создание API ключа
- `GET /server2/videoapi/auth/api-keys` - Список API ключей
- `DELETE /server2/videoapi/auth/api-keys/{key_id}` - Отзыв API ключа
- `DELETE /server2/videoapi/auth/api-keys` - Отзыв всех ключей
- `GET /server2/videoapi/auth/verify` - Проверка API ключа

## Технические детали

### Зависимости (requirements.txt)
```
fastapi>=0.104.0
uvicorn>=0.24.0
aiofiles>=23.2.0
aiohttp>=3.9.0
ffmpeg-python>=0.2.0
python-multipart>=0.0.6
pydantic>=2.5.0
PyJWT (используется в коде, но не указан в requirements.txt)
```

### Системные требования
- Python 3.12+
- FFmpeg (должен быть установлен в системе)
- Доступ к `/tmp` для временных файлов
- Порты: 3001 (по умолчанию)

### Конфигурация
- **SECRET_KEY**: "your-secret-key-change-in-production" (нужно изменить в продакшене!)
- **ALGORITHM**: HS256
- **ACCESS_TOKEN_EXPIRE_HOURS**: 1
- **Root path**: `/scotch`
- **Base URL**: `https://your-domain.com/scotch` (настройте под ваш домен)

### Хранение данных
- Пользователи: `users.json` (хешированные пароли)
- API ключи: `api_keys.json` (хешированные ключи)
- Резервные копии: `backups/` (автоматические бэкапы при изменении)

### Обработка видео
- Скачивание видео с URL (лимит 20 МБ на видео)
- Нормализация видео перед склейкой
- Использование FFmpeg для объединения
- Временные файлы хранятся в `/tmp/`
- Результаты доступны по URL

### Rate Limiting
- В коде есть функция `check_rate_limit()`, но она отключена (pass)
- Теоретический лимит: 20 запросов в час (не реализован)

## Особенности реализации

1. **Двойная система аутентификации**: JWT токены для веб-интерфейса и API ключи для программного доступа
2. **Персистентное хранение**: Все данные в JSON файлах (не БД)
3. **Кэширование**: Результаты склейки кэшируются в памяти
4. **Прогресс задач**: Отслеживание прогресса обработки видео
5. **Автоматическая очистка**: Удаление временных файлов после обработки
6. **Резервное копирование**: Автоматические бэкапы API ключей

## Безопасность

- Хеширование паролей (PBKDF2-SHA256)
- Хеширование API ключей (SHA256)
- JWT токены с истечением срока действия
- Проверка срока действия API ключей
- Возможность отзыва API ключей

## Известные ограничения

1. Rate limiting отключен (функция пустая)
2. SECRET_KEY нужно изменить в продакшене
3. Нет миграции данных между версиями
4. Нет автоматической очистки старых задач из `/tmp/`
5. Кэш хранится только в памяти (теряется при перезапуске)

