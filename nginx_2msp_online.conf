# Редирект HTTP на HTTPS
server {
    listen 80;
    server_name 2msp.online www.2msp.online;
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# Основной сервер HTTPS
server {
    listen 443 ssl http2;
    server_name 2msp.online www.2msp.online;

    # SSL сертификаты
    ssl_certificate /etc/letsencrypt/live/2msp.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/2msp.online/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

    client_max_body_size 25M;

    # Redirect /msp to /mcp (common typo)
    location = /msp {
        return 301 https://$host/mcp;
    }

    # Redirect /mcp/ to /mcp (remove trailing slash)
    location = /mcp/ {
        return 301 https://$host/mcp;
    }

    # MCP Info endpoint
    location = /mcp-info {
        proxy_pass http://127.0.0.1:8000/mcp-info;
        proxy_set_header Host $host;
    }

    # Health check endpoints
    location = /health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
    }

    location = /mcp-health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
    }

    # MCP сервер - SSE endpoint
    location = /sse/ {
        return 301 https://$host/sse;
    }

    location /sse {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_buffering off;
        proxy_cache off;
    }

    # MCP сервер - Streamable HTTP endpoint
    location /mcp {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Astro приложение
    location /astro/ {
        alias /X/opt/astro/;
        index index.html;
        autoindex off;
    }

    location = /astro {
        return 301 /astro/;
    }

    # Jotish приложение
    location /jotish/ {
        alias /X/opt/jotish/;
        index index.html;
        autoindex off;
    }

    location = /jotish {
        return 301 /jotish/;
    }

    # WordPress paths - проксируем на mcp.2msp.online где установлен WordPress
    location ~ ^/(wp-admin|wp-login|wp-json|wp-content|wp-includes|xmlrpc.php|wp-cron.php) {
        proxy_pass https://mcp.2msp.online;
        proxy_set_header Host mcp.2msp.online;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_verify off;
    }

    # Главная страница - статический HTML
    location = / {
        root /var/www/html;
        try_files /index.html =404;
    }

    # Видео-приложение
    location /video/ {
        proxy_pass http://127.0.0.1:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    location = /video {
        return 301 /video/;
    }

    # Все остальные пути - проксируем на видео-приложение (для обратной совместимости)
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
